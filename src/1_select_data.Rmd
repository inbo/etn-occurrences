---
title: "Select transmitter and receiver data"
subtitle: "ETN - LifeWatch.be acoustic telemetry data of fish"
author:
- Lien Reysehove
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
#  pdf_document:
#    df_print: kable
#    number_sections: yes
#    toc: yes
#    toc_depth: 3
---

# Setup 

```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Install packages

```{r}
library(tidyverse)      # To do data science
library(magrittr)       # To use %<>% pipes
library(here)           # To find files
library(janitor)        # To clean input data
library(etn)            # To interact with ETN
library(lubridate)      # To process date and time information
library(glue)
```

# Connect to database

Get username/password from environment (therefore requires this script to be run on <http://rstudio.lifewatch.be>) and connect to database:

```{r}
my_con <- connect_to_etn(Sys.getenv("username"), Sys.getenv("password"))
```

# Select detections

We need to retrieve the detection data related to the following animal projects:

- 2012 Leopoldkanaal
- 2013 Albertkanaal (excluding Sync tag data)
- 2014 Demer
- 2015 Dijle
- 2015 Phd Verhelst (only for _Anguilla anguilla_)
- Homarus
- Phd Reubens (only for _Gadus morhua_)

Select all tag information from all animal projects of interest:

```{r}
detections_query <- glue_sql(
    "SELECT DISTINCT transmitter
    FROM vliz.detections_view AS detections
    WHERE 
      (animal_project_code = '2011_rivierprik' 
        OR animal_project_code = '2012_leopoldkanaal'
        OR animal_project_code = '2013_albertkanaal'
        OR animal_project_code = '2014_demer'
        OR animal_project_code = '2015_dijle'
        OR (animal_project_code = '2015_phd_verhelst' AND scientific_name = 'Anguilla anguilla')
        OR animal_project_code = 'homarus'
        OR animal_project_code = 'phd_reubens')
      AND NOT scientific_name = 'Sentinel'
      AND NOT scientific_name = 'Sync tag'" ,
    .con = my_con)

transmitters <- dbGetQuery(my_con, detections_query)
as_tibble(transmitters)
```

Create vector `transmitters`. We will use this information later to extract all information relating to these specific transmitters.

```{r}
transmitters <- transmitters %>% pull(transmitter)
```

Inspect how many detections are related to these specific transmitters:

```{r}
detections_query <- glue_sql(
    "SELECT COUNT(id_pk) 
    FROM vliz.detections_view AS detections
    WHERE transmitter IN ({transmitters*})",
    transmitters = transmitters,
    .con = my_con
  )
receivers <- dbGetQuery(my_con, detections_query)
as_tibble(receivers)
```

# Select deployments

Extract all receivers involved in the detections of the specific animal projects listed earlier. We can't select on specific animal projects here. Hence, we use the network projects included in the animal projects.

```{r}
query <- glue_sql(
    "SELECT *
      FROM vliz.deployments_view AS deployments
      WHERE projectcode = 'albert'
        OR projectname = 'bovenschelde'
        OR projectname = 'bpns'
        OR projectname = 'demer'
        OR projectname = 'dijle'
        OR projectname = 'leopoldkanaal'
        OR projectname = 'maas'
        OR projectname = 'saeftinghe'
        OR projectname = 'ws1'
        OR projectname = 'ws2'
        OR projectname = 'ws3'    ",
    .con = my_con)

deployments <- dbGetQuery(my_con, query)
as_tibble(deployments)
```

Export `deployments` as .csv:

```{r}
write_csv(deployments, "../data/raw/deployments.csv", na = "")
```

