---
title: "Select transmitter and receiver data"
subtitle: "ETN - LifeWatch.be acoustic telemetry data of fish"
author:
- Lien Reysehove
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
#  pdf_document:
#    df_print: kable
#    number_sections: yes
#    toc: yes
#    toc_depth: 3
---

# Setup 

```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Install packages

```{r}
library(tidyverse)      # To do data science
library(magrittr)       # To use %<>% pipes
library(here)           # To find files
library(janitor)        # To clean input data
library(etn)            # To interact with ETN
library(lubridate)      # To process date and time information
library(glue)
```

# Connect to database

Get username/password from environment (therefore requires this script to be run on <http://rstudio.lifewatch.be>) and connect to database:

```{r}
my_con <- connect_to_etn(Sys.getenv("username"), Sys.getenv("password"))
```

# Select deployments

Extract all receivers involved in the detections of the specific animal projects listed earlier. We can't select on specific animal projects here. Hence, we use the network projects included in the animal projects.

```{r}
query <- glue_sql(
    "SELECT *
      FROM vliz.deployments_view AS deployments
      WHERE projectcode = 'albert'
        OR projectcode = 'bovenschelde'
        OR projectcode = 'bpns'
        OR projectcode = 'demer'
        OR projectcode = 'dijle'
        OR projectcode = 'leopoldkanaal'
        OR projectcode = 'maas'
        OR projectcode = 'saeftinghe'
        OR projectcode = 'ws1'
        OR projectcode = 'ws2'
        OR projectcode = 'ws3'    ",
    .con = my_con)

deployments <- dbGetQuery(my_con, query)
as_tibble(deployments)
```

Export `deployments` as .csv:

```{r}
write_csv(deployments, "../data/raw/deployments.csv", na = "")
```

# Select receivers

```{r}
query <- glue_sql("
      SELECT DISTINCT 
        receivers.* ,
        deployments.projectcode,
        etn_group.name as owner_organisation
      FROM vliz.receivers
        JOIN vliz.deployments_view deployments ON (receivers.id_pk = deployments.receiver_fk)
        JOIN vliz.etn_group AS etn_group ON (receivers.owner_group_fk = etn_group.id_pk)
       WHERE projectcode = 'albert'
        OR projectcode = 'bovenschelde'
        OR projectcode = 'bpns'
        OR projectcode = 'demer'
        OR projectcode = 'dijle'
        OR projectcode = 'leopoldkanaal'
        OR projectcode = 'maas'
        OR projectcode = 'saeftinghe'
        OR projectcode = 'ws1'
        OR projectcode = 'ws2'
        OR projectcode = 'ws3'    ",
      .con = my_con)

receivers <- dbGetQuery(my_con, query)
as_tibble(receivers)
```

Export `receivers` as .csv:

```{r}
write_csv(receivers, "../data/raw/receivers.csv", na = "")
```

