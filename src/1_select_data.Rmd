---
title: "Select transmitter and receiver data"
subtitle: "ETN - LifeWatch.be acoustic telemetry data of fish"
author:
- Lien Reysehove
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
#  pdf_document:
#    df_print: kable
#    number_sections: yes
#    toc: yes
#    toc_depth: 3
---

# Setup 

```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Install packages

```{r}
library(tidyverse)      # To do data science
library(magrittr)       # To use %<>% pipes
library(here)           # To find files
library(janitor)        # To clean input data
library(etn)            # To interact with ETN
library(lubridate)      # To process date and time information
library(glue)
library(odbc)
```

# Connect to database

Get username/password from environment (therefore requires this script to be run on <http://rstudio.lifewatch.be>) and connect to database:

```{r}
my_con <- connect_to_etn(Sys.getenv("username"), Sys.getenv("password"))
```

# Select transmitters

We need to retrieve the transmitter and receivers involved in the following animal projects:

- 2012 Leopoldkanaal
- 2013 Albertkanaal (excluding Sync tag data)
- 2014 Demer
- 2015 Dijle
- 2015 Phd Verhelst (only for _Anguilla anguilla_)
- Homarus
- Phd Reubens (only for _Gadus morhua_)

Select all tag information from all animal projects of interest:

```{r}
detections_query <- glue_sql(
    "SELECT DISTINCT transmitter
    FROM vliz.detections_view AS detections
    WHERE 
      (animal_project_code = '2011_rivierprik' 
        OR animal_project_code = '2012_leopoldkanaal'
        OR animal_project_code = '2013_albertkanaal'
        OR animal_project_code = '2014_demer'
        OR animal_project_code = '2015_dijle'
        OR (animal_project_code = '2015_phd_verhelst' AND scientific_name = 'Anguilla anguilla')
        OR animal_project_code = 'homarus'
        OR animal_project_code = 'phd_reubens')
      AND NOT scientific_name = 'Sentinel'
      AND NOT scientific_name = 'Sync tag'" ,
    .con = my_con)

transmitters <- dbGetQuery(my_con, detections_query)
as_tibble(transmitters)
```

Create vector `transmitters`. We will use this information later to extract all information relating to these specific transmitters.

```{r}
transmitters <- transmitters %>% pull(transmitter)
```

Inspect how many detections are related to these specific transmitters:

```{r}
detections_query <- glue_sql(
    "SELECT COUNT(id_pk) 
    FROM vliz.detections_view AS detections
    WHERE transmitter IN ({transmitters*})",
    transmitters = transmitters,
    .con = my_con
  )
receivers <- dbGetQuery(my_con, detections_query)
as_tibble(receivers)
```

# Select receivers

Extract all receivers involved in the detections of the specific transmitters listed earlier:

```{r}
detections_query <- glue_sql(
    "SELECT DISTINCT receiver 
    FROM vliz.detections_view AS detections
    WHERE transmitter IN ({transmitters*})",
    transmitters = transmitters,
    .con = my_con
  )
receivers <- dbGetQuery(my_con, detections_query)
as_tibble(receivers)
```

Create vector `receivers`. We will use this information to extract all receiver deployments.

```{r}
receivers <- receivers %>% pull(receiver)
```

Extract all deployment information for the specific receivers:

```{r}
query <- glue_sql(
    "SELECT *
    FROM vliz.deployments_view
    WHERE receiver IN ({receiver*})
    ORDER BY receiver
    ",
    receiver = receivers,
    .con = my_con)

deployments <- dbGetQuery(my_con, query)
as_tibble(deployments)
```

Export `deployments` as .csv:

```{r}
write_csv(deployments, "../data/raw/deployments.csv", na = "")
```

Extract all receiver metadata for the specific receivers:

```{r}
query <- glue_sql(
    "SELECT *
    FROM vliz.receivers",
    .con = my_con)

receivers <- dbGetQuery(my_con, query)
as_tibble(receivers)
```

Export `receivers` as .csv:

```{r}
write_csv(receivers, "../data/raw/receivers.csv", na = "")
```
