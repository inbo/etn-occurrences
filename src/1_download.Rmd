---
title: "Download ETN data"
author:
- Lien Reyserhove
- Peter Desmet
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    number_sections: true
    toc: true
    toc_depth: 3
    toc_float: true
---

This script downloads data from the [European Tracking Network (ETN)](http://www.lifewatch.be/etn/) database using the [etn R package](https://inbo.github.io/etn/). It starts by defining the animal project (and optional scientific name filter) of interest and then exporting the `animals`, `tags`, `receivers`, `deployments` and `detections` for that project as csv files. Due to the nature of the ETN database, this script will only function on the [LifeWatch RStudio server](http://rstudio.lifewatch.be/). 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

Load libraries:

```{r}
library(tidyverse)      # To do data science
library(magrittr)       # To use %<>% pipes
library(here)           # To find files
library(etn)            # To interact with ETN
```

## Connect to ETN database

Get username/password from RStudio Server environment and connect to database:

```{r}
# con <- connect_to_etn(Sys.getenv("username"), Sys.getenv("password"))
con <- connect_to_etn(Sys.getenv("userid"), Sys.getenv("pwd"))
```

## Define datasets to be exported

The animal projects (with additional scientific name filter) that will be published as open datasets:

```{r}
datasets <- tribble(
  ~project_code,  ~scientific_name,
  "2011_rivierprik", NULL,
  "2012_leopoldkanaal", NULL,
  "2013_albertkanaal", c("Anguilla anguilla", "Salmo salar"), # Excludes 'Sync tag'
  "2014_demer", NULL,
  "2015_dijle", NULL,
  "2015_phd_verhelst", "Anguilla anguilla",
  "homarus", NULL,
  "phd_reubens", "Gadus morhua" # Excludes 'Sentinel'
)
```

## Select single dataset

Select a dataset to export. Change `project_code` to download another dataset:

```{r}
dataset <- datasets %>% filter(project_code == "2011_rivierprik") 
```

## Get data

Get animal metadata:

```{r}
animals <- get_animals(
  connection = con,
  animal_project_code = dataset$project_code,
  scientific_name = unlist(dataset$scientific_name)
)
```

Show animals with multiple tags:

```{r}
animals_multiple_tags <-
  animals %>%
  filter(str_detect(tag_id, ",")) %>%
  select(animal_id, tag_id)
animals_multiple_tags
```

Show tags with multiple animals:

```{r}
tags_multiple_animals <-
  animals %>%
  group_by(tag_id) %>% 
  filter(n() > 1) %>%
  select(animal_id, tag_id, release_date_time, recapture_date_time, length1)
tags_multiple_animals
```

Select tags associated with animals:

```{r}
tag_ids <-
  animals %>%
  select(tag_id) %>%
  pull() %>%
  unique() # Should normally be the case as tags are not reused for animals
```

Get tag metadata:

```{r}
tags <- get_tags(connection = con, tag_id = tag_ids)
```

Get detections for selected project / scientific name:

```{r}
detections <- get_detections(
  connection = con, 
  animal_project_code = dataset$project_code,
  scientific_name = unlist(dataset$scientific_name),
  limit = FALSE
)
```

Show orphaned deployments in the detections. Ideally these should be assigned to a real `network_project_code` (see [this issue](https://github.com/inbo/etn-occurrences/issues/71) as an example):

```{r}
incorrect_network_codes <- c("none", "no_info")

orphaned_deployments <-
  detections %>%
  filter(network_project_code %in% incorrect_network_codes | is.na(network_project_code)) %>%
  group_by(receiver_id, deployment_fk, network_project_code) %>%
  summarize(
    `from` = min(date_time),
    `to` = max(date_time),
    `detections` = n()
  )
orphaned_deployments
```

Select network projects listed in detections (excluding `no_info` or `none` projects):

```{r}
network_project_codes <-
  detections %>%
  select(network_project_code) %>%
  unique() %>%
  filter(!network_project_code %in% incorrect_network_codes) %>%
  arrange() %>%
  pull()
```

Show included network projects. It is up to the project PI to leave this as is or expand it with other (e.g. neighbouring) network projects that did not result in detections:

```{r}
network_project_codes
```

Get deployment metadata for those network projects:

```{r}
deployments <- get_deployments(con, network_project_code = network_project_codes, open_only = FALSE)
```

Remove linebreaks in deployment comments to get single lines in csv:

```{r}
deployments <-
  deployments %>%
  mutate(comments = str_replace_all(comments, "[\r\n]+", " "))
```

Select receivers associated with those deployments:

```{r}
receiver_ids <- deployments %>% distinct(receiver_id) %>% pull()
```

Get receiver metadata:

```{r}
receivers <- get_receivers(con, receiver_id = receiver_ids)
```

## Summary stats

```{r}
stats <- data.frame(
  "stat" = c(
    "animal project",
    "scientific names",
    "animals",
    "animals multiple tags",
    "tags multiple tags",
    "tags",
    "detections",
    "network projects",
    "deployments",
    "orphaned deployments",
    "receivers in deployments",
    "receivers"
  ),
  "value" = c(
    dataset$project_code,
    nrow(animals %>% distinct(scientific_name)),
    nrow(animals),
    nrow(animals_multiple_tags),
    nrow(tags_multiple_animals %>% distinct(tag_id)),
    nrow(tags),
    nrow(detections),
    length(network_project_codes),
    nrow(deployments),
    nrow(orphaned_deployments),
    length(receiver_ids),
    nrow(receivers)
  )
)
stats
```

## Save to csv

```{r}
write_csv(animals, here::here("data", "processed", dataset$project_code, "animals.csv"), na = "")
write_csv(tags, here::here("data", "processed", dataset$project_code, "tags.csv"), na = "")
write_csv(detections, here::here("data", "processed", dataset$project_code, "detections.csv"), na = "")
write_csv(deployments, here::here("data", "processed", dataset$project_code, "deployments.csv"), na = "")
write_csv(receivers, here::here("data", "processed", dataset$project_code, "receivers.csv"), na = "")
```
