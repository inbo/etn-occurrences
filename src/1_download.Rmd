---
title: "Export data"
subtitle: "ETN - LifeWatch.be acoustic telemetry data of fish"
author:
- Lien Reysehove
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
#  pdf_document:
#    df_print: kable
#    number_sections: yes
#    toc: yes
#    toc_depth: 3
---

# Setup 

```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Install packages

```{r}
library(tidyverse)      # To do data science
library(magrittr)       # To use %<>% pipes
library(here)           # To find files
library(etn)            # To interact with ETN
library(glue)
```

# Connect to database

Get username/password from environment (therefore requires this script to be run on <http://rstudio.lifewatch.be>) and connect to database:

```{r}
my_con <- connect_to_etn(Sys.getenv("username"), Sys.getenv("password"))
```

# Define selection criteria

We will extract the animal and transmitter data based on the animal ID's of interest. These are the animal ID's integrated in the following animal projects:

- 2011 Rivierprik
- 2012 Leopoldkanaal
- 2013 Albertkanaal (excluding _Sync tag_)
- 2014 Demer
- 2015 Dijle
- 2015 Phd Verhelst (only for _Anguilla anguilla_)
- Homarus
- Phd Reubens (only for _Gadus morhua_)

# Define selection criteria

```{r}
project_name <- "2011_rivierprik"
```


# Get data (test: here for animal project 2011_rivierprik)

Animal metadata:

```{r}
animals <- get_animals(connection = my_con, animal_project_code = project_name)
```

Retrieve transmitter (tag) id's:

```{r}
tags <- animals %>% select(tag_id) %>% pull()
```

Retrieve transmitter information:

```{r}
transmitters <- get_tags(connection = my_con, tag_id = tags)
```

Retrieve detection data:

```{r}
detections <- get_detections(connection = my_con, animal_project_code = project_name, limit = FALSE)
```

Extract receiver id's from `detections`

```{r}
ids <- detections %>% select(receiver_id) %>% pull() %>% unique()
```

Extract receiver information:

```{r}
receivers <- get_receivers(my_con, receiver_id = ids)
```

Extract deployment information:

```{r}
all_deployments <- get_deployments(my_con, open_only = FALSE)
```

```{r}
deployments <- all_deployments %>% filter(receiver_id %in% ids)
```

# Save to csv

Save to CSV:

```{r}
write_csv(animals, here::here("data", project_name, "animals.csv"), na = "")
write_csv(transmitters, here::here("data", project_name, "transmitters.csv"), na = "")
write_csv(detections, here::here("data", project_name, "detections.csv"), na = "")
write_csv(receivers, here::here("data", project_name, "receivers.csv"), na = "")
write_csv(deployments, here::here("data", project_name, "deployments.csv"), na = "")
```




