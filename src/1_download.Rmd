---
title: "Download ETN data"
author:
- Lien Reyserhove
- Peter Desmet
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    number_sections: true
    toc: true
    toc_depth: 3
    toc_float: true
---

This script downloads data from the [European Tracking Network (ETN)](http://www.lifewatch.be/etn/) database using the [etn R package](https://inbo.github.io/etn/). It starts by defining the animal project (and optional scientific name filter) of interest and then exporting the `animals`, `tags`, `receivers`, `deployments` and `detections` for that project as csv files. Due to the nature of the ETN database, this script will only function on the [LifeWatch RStudio server](http://rstudio.lifewatch.be/). 

```{r}
tribble(
  ~project_code,  ~scientific_name,
  "2011_rivierprik", "all scientific names",
  "2012_leopoldkanaal", "all scientific names",
  "2013_albertkanaal", "Anguilla anguilla, Salmo salar",
  "2014_demer", "all scientific names",
  "2015_dijle", "all scientific names",
  "2015_phd_verhelst", "Anguilla anguilla",
  "homarus", "all scientific names",
  "phd_reubens", "Gadus morhua"
)
```
```{r, echo = FALSE}
project_variables <- tribble(
  ~project_code,  ~scientific_name,
  "2011_rivierprik", NULL,
  "2012_leopoldkanaal", NULL,
  "2013_albertkanaal", c("Anguilla anguilla","Salmo salar"),
  "2014_demer", NULL,
  "2015_dijle", NULL,
  "2015_phd_verhelst", "Anguilla anguilla",
  "homarus", NULL,
  "phd_reubens", "Gadus morhua"
)
```


# Setup 

```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Install packages

```{r}
library(tidyverse)      # To do data science
library(magrittr)       # To use %<>% pipes
library(here)           # To find files
library(etn)            # To interact with ETN
```

# Connect to database

Get username/password from environment (therefore requires this script to be run on <http://rstudio.lifewatch.be>) and connect to database:

```{r}
my_con <- connect_to_etn(Sys.getenv("username"), Sys.getenv("password"))
```

# Define selection criteria

Define the specific animal project under `project_code == xxx`. 

```{r}
selection_criteria <- project_variables %>% filter(project_code == "phd_reubens") 
```

# Get data (test: here for animal project 2011_rivierprik)

Animal metadata:

```{r}
animals <- get_animals(
  connection = my_con,
  animal_project_code = selection_criteria$project_code,
  scientific_name = unlist(selection_criteria$scientific_name))
```

Retrieve tag id's:

```{r}
tag_ids <- animals %>% select(tag_id) %>% pull()
```

Retrieve tag information:

```{r}
tags <- get_tags(connection = my_con, tag_id = tag_ids)
```

Retrieve detection data:

```{r}
detections <- get_detections(
  connection = my_con, 
  animal_project_code = selection_criteria$project_code,
  scientific_name = unlist(selection_criteria$scientific_name),
  limit = FALSE)
```

Extract receiver id's from `detections`

```{r}
receiver_ids <- detections %>% select(receiver_id) %>% pull() %>% unique()
```

Extract receiver information:

```{r}
receivers <- get_receivers(my_con, receiver_id = receiver_ids)
```

Extract deployment information:

```{r}
deployments <- get_deployments(my_con, open_only = FALSE)
```

```{r}
deployments <- deployments %>% filter(receiver_id %in% receiver_ids)
```

# Save to csv

```{r}
write_csv(animals, here::here("data", selection_criteria $ project_code, "animals.csv"), na = "")
write_csv(tags, here::here("data", selection_criteria $ project_code, "tags.csv"), na = "")
write_csv(detections, here::here("data", selection_criteria $ project_code, "detections.csv"), na = "")
write_csv(receivers, here::here("data", selection_criteria $ project_code, "receivers.csv"), na = "")
write_csv(deployments, here::here("data", selection_criteria $ project_code, "deployments.csv"), na = "")
```




