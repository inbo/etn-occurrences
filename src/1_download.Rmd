---
title: "Export data"
subtitle: "ETN - LifeWatch.be acoustic telemetry data of fish"
author:
- Lien Reysehove
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
#  pdf_document:
#    df_print: kable
#    number_sections: yes
#    toc: yes
#    toc_depth: 3
---

# Setup 

```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Install packages

```{r}
library(tidyverse)      # To do data science
library(magrittr)       # To use %<>% pipes
library(here)           # To find files
library(etn)            # To interact with ETN
library(glue)
```

# Connect to database

Get username/password from environment (therefore requires this script to be run on <http://rstudio.lifewatch.be>) and connect to database:

```{r}
my_con <- connect_to_etn(Sys.getenv("username"), Sys.getenv("password"))
```

# Define selection criteria

We will extract the animal and transmitter data based on the animal ID's of interest. These are the animal ID's integrated in the following animal projects:

- 2011 Rivierprik
- 2012 Leopoldkanaal
- 2013 Albertkanaal (excluding _Sync tag_)
- 2014 Demer
- 2015 Dijle
- 2015 Phd Verhelst (only for _Anguilla anguilla_)
- Homarus
- Phd Reubens (only for _Gadus morhua_)


```{r}
project_variables <-
  tibble(
    project_code = c("2011_rivierprik", "2012_leopoldkanaal",
                     "2013_albertkanaal", "2014_demer",
                     "2015_dijle", "2015_phd_verhelst",
                     "homarus", "phd_reubens"),
    scientific_name = c("NULL", "NULL",
                        list(c("a", "b")), "NULL",
                        "NULL", "Anguilla anguilla",
                        "NULL","Gadus morhua" ))
project_variables
```

# Define selection criteria


```{r}
selection_criteria <- project_variables %>% filter(project_code == "2011_rivierprik")
```


# Get data (test: here for animal project 2011_rivierprik)

Animal metadata:

```{r}
animals <- get_animals(
  connection = my_con,
  animal_project_code = selection_criteria $ project_code,
  scientific_name = selection_criteria $ scientific_name)
```

Retrieve tag id's:

```{r}
tag_ids <- animals %>% select(tag_id) %>% pull()
```

Retrieve tag information:

```{r}
tags <- get_tags(connection = my_con, tag_id = tag_ids)
```

Retrieve detection data:

```{r}
detections <- get_detections(
  connection = my_con, 
  animal_project_code = selection_criteria $ project_code,
  limit = FALSE)
```

Extract receiver id's from `detections`

```{r}
receiver_ids <- detections %>% select(receiver_id) %>% pull() %>% unique()
```

Extract receiver information:

```{r}
receivers <- get_receivers(my_con, receiver_id = receiver_ids)
```

Extract deployment information:

```{r}
deployments <- get_deployments(my_con, open_only = FALSE)
```

```{r}
deployments <- deployments %>% filter(receiver_id %in% receiver_ids)
```

# Save to csv

Save to CSV:

```{r}
write_csv(animals, here::here("data", selection_criteria $ project_code, "animals.csv"), na = "")
write_csv(tags, here::here("data", selection_criteria $ project_code, "tags.csv"), na = "")
write_csv(detections, here::here("data", selection_criteria $ project_code, "detections.csv"), na = "")
write_csv(receivers, here::here("data", selection_criteria $ project_code, "receivers.csv"), na = "")
write_csv(deployments, here::here("data", selection_criteria $ project_code, "deployments.csv"), na = "")
```




