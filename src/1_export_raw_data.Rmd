---
title: "Export data"
subtitle: "ETN - LifeWatch.be acoustic telemetry data of fish"
author:
- Lien Reysehove
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
#  pdf_document:
#    df_print: kable
#    number_sections: yes
#    toc: yes
#    toc_depth: 3
---

This script is used to export data from the etn database to the [raw data folder](https://github.com/inbo/etn-occurrences/tree/master/data/raw) in this repository. The goal is to simplify data exploration. We use this for the following tables in the database:

- `vliz_animals.view`
- `vliz_tags`
- `vliz_deployments.view`
- `vliz_receivers`
- `vliz_detections.view`

# Setup 

```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Install packages

```{r}
library(tidyverse)      # To do data science
library(magrittr)       # To use %<>% pipes
library(here)           # To find files
library(DBI)            # To connect to database
library(etn)            # To interact with ETN
library(glue)           # To write SQL with variables
```

# Connect to database

Get username/password from environment (therefore requires this script to be run on <http://rstudio.lifewatch.be>) and connect to database:

```{r}
my_con <- connect_to_etn(Sys.getenv("username"), Sys.getenv("password"))
```

# Define selection criteria

We will extract the animal and transmitter data based on the **animal ID**'s of interest. These are the animal ID's integrated in the following animal projects:

- 2012 Leopoldkanaal
- 2013 Albertkanaal (excluding Sync tag data)
- 2014 Demer
- 2015 Dijle
- 2015 Phd Verhelst (only for _Anguilla anguilla_)
- Homarus
- Phd Reubens (only for _Gadus morhua_)

Create `animal_ids`:

```{r}
query <- glue_sql("
  SELECT DISTINCT id_pk
  FROM vliz.animals_view
  WHERE 
    (
      projectcode = '2011_rivierprik'
      OR projectcode = '2012_leopoldkanaal'
      OR projectcode = '2013_albertkanaal'
      OR projectcode = '2014_demer'
      OR projectcode = '2015_dijle'
      OR (projectcode = '2015_phd_verhelst' AND scientific_name = 'Anguilla anguilla')
      OR projectcode = 'homarus'
      OR projectcode = 'phd_reubens'
    )
    AND NOT scientific_name = 'Sentinel'
    AND NOT scientific_name = 'Sync tag'
  ", .con = my_con)

animal_ids <- dbGetQuery(my_con, query)
animal_ids <- animal_ids %>% pull(id_pk)
as.tibble(animal_ids)
```

The receiver and deployment data will be extrated by selecting on the specific **network projects**:

- Albertkanaal
- Bovenschelde
- BPNS
- Demer
- Dijle
- Leopoldkanaal
- Maas
- Saeftinghe
- Westerschelde 1
- Westerschelde 2
- Westerschelde 3
- Zeeschelde

Create `network_projects`:

```{r}
network_projects <- c("albert", "bovenschelde", "bpns", "demer", "dijle", "leopold", "maas", "saeftinghe", "ws1", "ws2", "ws3", "zeeschelde")
```

# Export raw animals data

Query data

```{r}
query <- glue_sql("
  SELECT *
  FROM vliz.animals_view
  WHERE id_pk IN ({animal_ids*})
  ", .con = my_con)

animals <- dbGetQuery(my_con, query)
as_tibble(animals)
```

Export data to `raw`:

```{r}
animals %>% write_csv(here::here("data", "raw", "animals.csv"), na = "")
```

# Export raw transmitter data

Query data:

```{r}
query <- glue_sql("
  SELECT
    tags.*,
    animals.projectcode,
    animals.scientific_name,
    animals.id_pk AS animal_id_pk
  FROM
    vliz.tags
    LEFT JOIN vliz.animal_tag_release
      ON animal_tag_release.tag_fk = tags.id_pk
    LEFT JOIN vliz.animals_view AS animals
      ON animals.id_pk = animal_tag_release.animal_fk
  WHERE
    animals.id_pk IN ({animal_ids*})
  ", .con = my_con)

transmitters <- dbGetQuery(my_con, query)
as_tibble(transmitters)
```

Export transmitters data:

```{r}
transmitters %>% write_csv(here::here("data", "raw", "transmitters.csv"), na = "")
```

# Export raw deployment data

Query data:

```{r}
query <- glue_sql("
  SELECT *
  FROM vliz.deployments_view AS deployments
  WHERE projectcode IN ({network_projects*})
  ", .con = my_con)

deployments <- dbGetQuery(my_con, query)
as_tibble(deployments)
```

Export `deployments` as .csv:

```{r}
write_csv(deployments, here::here("data","raw","deployments.csv"), na = "")
```

# Export raw receiver data

Query data:

```{r}
query <- glue_sql("
  SELECT DISTINCT 
    receivers.* ,
    deployments.projectcode,
    etn_group.name AS owner_organisation
  FROM
    vliz.receivers
    JOIN vliz.deployments_view deployments
      ON receivers.id_pk = deployments.receiver_fk
    JOIN vliz.etn_group AS etn_group
      ON receivers.owner_group_fk = etn_group.id_pk
  WHERE projectcode IN ({network_projects*})
  ", .con = my_con)

receivers <- dbGetQuery(my_con, query)
as_tibble(receivers)
```

Export `receivers` as .csv:

```{r}
write_csv(receivers, here::here("data","raw","receivers.csv"), na = "")
```

# Export raw detection data

The database table `vliz_detections.view` is too large to extract as a whole. We use a custom function to extract the data for each `animal_id` separately.  

1. Load custom function to iterate over animal ids:

```{r}
source(here::here("src", "functions", "download_raw_detections.R"))
```

2. Query and save data (one csv file per animal id):

```{r}
download_raw_detections(
  sql_file = here::here("sql", "raw_detections.sql"),
  download_directory = here::here("data", "raw", "detections"),
  animal_ids = animal_ids,
  con = my_con,
  overwrite = TRUE
)
```
