---
title: "Download ETN data in raw format"
author:
- Lien Reysehove
- Peter Desmet
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
---

```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

This script is used to export data in raw format from the [European Tracking Network (ETN)](http://www.lifewatch.be/etn/) database hosted by the Flanders Marine Institute (VLIZ) as part of the Flemish contribution to LifeWatch. Data are exported to the [raw data directory](../data/raw) and include:

- animals (`vliz.animals_view`)
- transmitters (`vliz.tags`)
- receivers (`vliz.receivers`)
- receiver deployments (`vliz.deployments_view`)
- detections (`vliz.detections_view`)

Load libraries:

```{r}
library(tidyverse)      # To do data science
library(magrittr)       # To use %<>% pipes
library(here)           # To find files
library(DBI)            # To connect to database
library(etn)            # To interact with ETN
library(glue)           # To write SQL with variables
```

## Connect to ETN database

Username and password information is read from the R Studio environment, which is why this script needs to be run from <http://rstudio.lifewatch.be>.

```{r connect_to_etn}
my_con <- connect_to_etn(Sys.getenv("username"), Sys.getenv("password"))
```

## Define selection criteria

### Select animals

Animals (and associated transmitter data) are selected based on the **animal projects**:

```{r}
query <- glue_sql("
  SELECT DISTINCT id_pk
  FROM vliz.animals_view
  WHERE 
    projectcode = '2011_rivierprik'
    OR projectcode = '2012_leopoldkanaal'
    OR (projectcode = '2013_albertkanaal' AND NOT scientific_name = 'Sync tag')
    OR projectcode = '2014_demer'
    OR projectcode = '2015_dijle'
    OR (projectcode = '2015_phd_verhelst' AND scientific_name = 'Anguilla anguilla')
    OR projectcode = 'homarus'
    OR (projectcode = 'phd_reubens' AND NOT scientific_name = 'Sentinel')
  ", .con = my_con)

animal_ids <- dbGetQuery(my_con, query)
animal_ids <- animal_ids %>% pull(id_pk)
length(animal_ids)
```

Save `animal_ids` to CSV:

```{r}
write_csv(as.data.frame(animal_ids), here::here("data", "interim", "animal_ids.csv"), col_names = FALSE)
```

### Select network projects

Receiver and deployment data are selected based **network projects**:

```{r}
network_projects <- c(
  "albert",         # Albertkanaal
  "bovenschelde",   # Bovenschelde
  "bpns",           # BPNS
  "demer",          # Demer
  "dijle",          # Dijle
  "leopold",        # Leopoldkanaal
  "maas",           # Maes
  "saeftinghe",     # Saeftinghe
  "ws1",            # Westerschelde 1
  "ws2",            # Westerschelde 2
  "ws3",            # Westerschelde 3
  "zeeschelde"      # Zeeschelde
)
```

Save `network_projects` to CSV:

```{r}
write_csv(as.data.frame(network_projects), here::here("data", "interim", "network_projects.csv"), col_names = FALSE)
```

## Get animal data

Query data:

```{r}
query <- glue_sql("
  SELECT
    *
  FROM
    vliz.animals_view
  WHERE
    id_pk IN ({animal_ids*})
  ", .con = my_con)

animals <- dbGetQuery(my_con, query)
animals
```

Save to CSV:

```{r}
animals %>% write_csv(here::here("data", "raw", "animals.csv"), na = "")
```

# Get transmitter/tag data

Query data:

```{r}
query <- glue_sql("
  SELECT
    tags.*,
    animals.projectcode,
    animals.scientific_name,
    animals.id_pk AS animal_id_pk
  FROM
    vliz.tags
    LEFT JOIN vliz.animal_tag_release
      ON animal_tag_release.tag_fk = tags.id_pk
    LEFT JOIN vliz.animals_view AS animals
      ON animals.id_pk = animal_tag_release.animal_fk
  WHERE
    animals.id_pk IN ({animal_ids*})
  ", .con = my_con)

transmitters <- dbGetQuery(my_con, query)
transmitters
```

Save to CSV:

```{r}
transmitters %>% write_csv(here::here("data", "raw", "transmitters.csv"), na = "")
```

## Get receiver data

Query data:

```{r}
query <- glue_sql("
  SELECT DISTINCT 
    receivers.* ,
    deployments.projectcode,
    etn_group.name AS owner_organisation
  FROM
    vliz.receivers
    JOIN vliz.deployments_view deployments
      ON receivers.id_pk = deployments.receiver_fk
    JOIN vliz.etn_group AS etn_group
      ON receivers.owner_group_fk = etn_group.id_pk
  WHERE
    projectcode IN ({network_projects*})
  ", .con = my_con)

receivers <- dbGetQuery(my_con, query)
receivers
```

Save to CSV:

```{r}
write_csv(receivers, here::here("data", "raw", "receivers.csv"), na = "")
```

# Get deployment data

Query data:

```{r}
query <- glue_sql("
  SELECT
    *
  FROM
    vliz.deployments_view AS deployments
  WHERE
    projectcode IN ({network_projects*})
  ", .con = my_con)

deployments <- dbGetQuery(my_con, query)
deployments
```

Save to CSV:

```{r}
write_csv(deployments, here::here("data", "raw", "deployments.csv"), na = "")
```

# Get detection data

The data in `vliz_detections.view` is too large to extract as a whole. We therefore use a custom function to extract the data for each `animal_id` separately:

Load custom function to iterate over animal ids:

```{r}
source(here::here("src", "functions", "download_data.R"))
```

Query and save data (one csv file per animal id):

```{r}
download_data(
  sql_file = here("sql", "raw_detections.sql"),
  download_directory = here("data", "raw", "detections"),
  download_filename = "detections",
  animal_ids = animal_ids,
  con = my_con,
  overwrite = TRUE
)
```
