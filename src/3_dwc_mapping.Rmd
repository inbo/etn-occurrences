
# Setup 

```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Install packages

```{r}
library(tidyverse)
library(DBI)
library(here)
library(glue)
library(etn)
```

# Connect to database

Get username/password from environment (therefore requires this script to be run on <http://rstudio.lifewatch.be>) and connect to database:

```{r}
my_con <- connect_to_etn(Sys.getenv("username"), Sys.getenv("password"))
```

# Query data:

## Animal event data

Query animal metadata:

```{r}
animals_event_sql <- glue_sql(read_file(here::here("sql", "dwc_animals_event.sql")), .con = my_con)
animals_event_data <- dbGetQuery(my_con, animals_event_sql)
```

Export data:

```{r}
animals_event_data %>% 
  write_csv(here::here("data","processed", "dwc_animals_event.csv"),
            na = "")
```

## Animal occurrence data

Query animal occurrence data:

```{r}
animals_occ_sql <- glue_sql(read_file(here::here("sql", "dwc_animals_occ.sql")), .con = my_con)
animals_occ_data <- dbGetQuery(my_con, animals_occ_sql)
```

Export data:

```{r}
animals_occ_data %>% 
  write_csv(here::here("data","processed", "dwc_animals_occ.csv"),
            na = "")
```

## Animal emof data

Query animal emof capture data:

```{r}
animals_emof_capture_sql <- glue_sql(read_file(here::here("sql", "dwc_animals_emof_capture.sql")), .con = my_con)
animals_emof_capture_data <- dbGetQuery(my_con, animals_emof_capture_sql)
```




Export data:

```{r}
animals_emof_data %>% 
  write_csv(here::here("data","processed", "dwc_animals_occ.csv"),
            na = "")
```


##  Deployment event

Query data:

```{r get_ref_data}
deployments_event_sql <- glue_sql(read_file(here::here("sql", "dwc_deployments_event.sql")), .con = my_con)
deployments_event_data <- dbGetQuery(my_con, deployments_event_sql)
```

Export as .csv:

```{r}
write_csv(deployments_event_data,
          here::here("data","processed", "dwc_event_deployments.csv"),
          na = "")
```

## Detections occurrences

Define all animal ids required for the selection of the appropriate detections:

```{r}
query <- glue_sql(
    "SELECT DISTINCT id_pk
    FROM vliz.animals_view
    WHERE 
      (projectcode = '2011_rivierprik' 
      OR projectcode = '2012_leopoldkanaal'
      OR projectcode = '2013_albertkanaal'
      OR projectcode = '2014_demer'
      OR projectcode = '2015_dijle'
      OR (projectcode = '2015_phd_verhelst' AND scientific_name = 'Anguilla anguilla')
        OR projectcode = 'homarus'
        OR projectcode = 'phd_reubens')
      AND NOT scientific_name = 'Sentinel'
      AND NOT scientific_name = 'Sync tag'
    " ,
    .con = my_con)

animal_ids <- dbGetQuery(my_con, query)
as_tibble(animal_ids)
```

Generate vector `animal_ids`:

```{r}
animal_ids <- animal_ids %>% pull(id_pk)
```

Load custom function to iterate over animal ids:

```{r}
source(here::here("src", "functions", "download_detections.R"))
```

Query and save data (one csv file per animal id):

```{r}
download_detections(
  sql_file = here::here("sql", "dwc_detections_occ.sql"),
  download_directory = here::here("data", "processed"),
  animal_ids = c(729, 728),
  con = my_con,
  overwrite = TRUE
)
```


