---
title: "Darwin Core mapping"
subtitle: "ETN - LifeWatch.be acoustic telemetry data of fish"
author:
- Lien Reysehove
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
#  pdf_document:
#    df_print: kable
#    number_sections: yes
#    toc: yes
#    toc_depth: 3
---

# Setup 

```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Install packages

```{r}
library(tidyverse)      # To do data science
library(magrittr)       # To use %<>% pipes
library(here)           # To find files
library(janitor)        # To clean input data
library(etn)            # To interact with ETN
library(lubridate)      # To process date and time information
```

# Read source data

Get username/password from environment (therefore requires this script to be run on <http://rstudio.lifewatch.be>) and connect to database:

```{r}
my_con <- connect_to_etn(Sys.getenv("username"), Sys.getenv("password"))
```

Import animal and transmitter data:

```{r}
input_animals <- get_animals(my_con)
input_tags    <- get_transmitters(my_con)
```

Filter on requested animal projects (see [issue 7](https://github.com/inbo/etn-occurrences/issues/7#issue-400197622) for a discussion on the selection of animal projects):

```{r}
input_animals %<>% 
  filter(projectname %in% c("2011 Rivierprik",
                            "2012 Leopoldkanaal",
                            "2013 Albertkanaal",
                            "2014 Demer",
                            "2015 Dijle",
                            "2015 PhD Verhelst",
                            "Homarus",
                            "PhD Jan Reubens"))

# Exclude data from the following animal projects: 
# `scientific_name`= `Sync tag` in `projectname` = `2013 Albertkanaal` 
# `scientific_name` = `Gadus morhua` in `projectname` = `2015 PhD Verhelst`
input_animals <-
  input_animals %>% 
    filter(!(projectname == "2013 Albertkanaal" & scientific_name == "Sync tag")) %>%
    filter(!(projectname == "2015 PhD Verhelst" & scientific_name == "Gadus morhua")) %>% 
    filter(!(projectname == "PhD Jan Reubens" & scientific_name == "Sentinel"))
```

We only need tag information from these specific animal project. Filter out the rest:

```{r}
input_tags %<>% semi_join(
  select(input_animals, tag_full_id),
  by = "tag_full_id")
```

Save to CSV:

```{r}
write_csv(input_animals, path = "../data/raw/input_animals.csv", na = "")
write_csv(input_tags, path = "../data/raw/input_tags.csv", na = "")
```

Both source datasets are assumed to be tidy and need no further data processing before the mapping.

# Event Core

We here map the data to [Darwin Core Event](http://rs.gbif.org/core/dwc_event_2016_06_21.xml).

The event core includes data of three separate events (overview in [issue 31](https://github.com/inbo/etn-occurrences/issues/31):
- Capture event
- Surgery event
- Release event

For a specific animal, each event differs in its date, location and protocol. 
We will thus map each event separately, combine them afterwards into one `event` core and add (1) metadata fields and (2) static fields that are independent from the specific event

## Capture event

```{r}
event_capture <- input_animals
```

This is an overview of the information related to the capture event:

```{r}
event_capture %>% 
  select(projectname, id_pk, capture_location, capture_depth, catched_date_time, capture_latitude, capture_longitude, capture_method) %>% 
  head(n = 30)
```

At first inspection, `capture_depth` appears to be empty. We need to verify this:

```{r}
event_capture %>% 
  summarize(non_na_records = sum(!is.na(capture_depth)))
  
```

`capture_depth` is thus not considered in this mapping as it is empty.

View content and structure of `event_capture`:

### eventID

EventID is a combination between:
- `projectcode`: refering to the animal project
- `id_pk`: unique identifier for a specific animal
- `event_capture`

```{r}
event_capture %<>% mutate(dwc_eventID = paste(projectcode, id_pk,"event-capture", sep = ":")) 
```

### samplingProtocol

For an overview and discussion on the specific content of this field, see [issue 17](https://github.com/inbo/etn-occurrences/issues/17)

```{r}
event_capture %<>% mutate(dwc_samplingProtocol = capture_method)
```

### eventDate

`catched_date_time` should follow ISO-8601 format (yyyy-mm-ddThh:mm:ssZ; as in: 2017-06-27T12:00:00Z):
(this means that the )

```{r}
unique(!is.na(parse_date_time(event_capture$catched_date_time,orders="ymd_HMS")))
```

```{r}
event_capture %<>% mutate(dwc_eventDate = catched_date_time)
```

### locality

For a discussion on the content of `capture_location`, see [issue 34](https://github.com/inbo/etn-occurrences/issues/34)

```{r}
event_capture %<>% mutate(dwc_locality = capture_location)
```

### decimalLatitude

For a discussion on the content of `decimalLatitude` see [issue11](https://github.com/inbo/etn-occurrences/issues/11)

```{r}
event_capture %<>% mutate(dwc_decimalLatitude = capture_latitude)
```

### decimalLongitude

For a discussion on the content of `decimalLongitude` see [issue11](https://github.com/inbo/etn-occurrences/issues/11)

```{r}
event_capture %<>% mutate(dwc_decimalLongitude = capture_longitude)
```

## Surgery Event

For a discussion on the amount of records to include in the surgery event, see [issue 47](https://github.com/inbo/etn-occurrences/issues/47). At this point, we will only include records with surgery data available.

```{r}
event_surgery <- input_animals %>% filter(!is.na(date_of_surgery))
```

This is an overview of the information related to the surgery event:

```{r}
event_surgery %>% 
  select(projectname, id_pk, date_of_surgery, surgery_location, surgery_latitude, surgery_longitude) %>% 
  head(n = 30)
```

At first inspection, `surgery_latitude` and `surgery_longitude` appear to be empty. We need to verify this:

```{r}
event_surgery %>% 
  summarize(non_na_records = sum(!is.na(surgery_latitude))) 
```

```{r}
event_surgery %>% 
  summarize(non_na_records = sum(!is.na(surgery_longitude)))
  
```

Both are empty at this point, but see [issue 43](https://github.com/inbo/etn-occurrences/issues/43)

### eventID

EventID is a combination between:
- `projectcode`: refering to the animal project
- `id_pk`: unique identifier for a specific animal
- `event_release`

```{r}
event_surgery %<>% mutate(dwc_eventID = paste(projectcode, id_pk,"event-surgery", sep = ":")) 
```

### samplingProtocol

```{r}
event_surgery %<>% mutate(dwc_samplingProtocol = "surgery") 
```

### eventDate

`date_of_surgery` should follow ISO-8601 format (yyyy-mm-ddThh:mm:ssZ; as in: 2017-06-27T12:00:00Z):
(this means that the )

```{r}
unique(!is.na(parse_date_time(event_surgery$date_of_surgery,orders="ymd_HMS")))
```

```{r}
event_surgery %<>% mutate(dwc_eventDate = date_of_surgery) 
```

### locality

For a discussion on the content of `surgery_location` see [issue42](https://github.com/inbo/etn-occurrences/issues/42)

```{r}
event_surgery %<>% mutate(dwc_locality = surgery_location) 
```

### decimalLatitude

At this point, no `decimalLatitude` has been provided. This should be integrated asap. See [issue 43](https://github.com/inbo/etn-occurrences/issues/43)

```{r}
event_surgery %<>% mutate(dwc_decimalLatitude = as.numeric("")) 
```

### decimalLongitude

```{r}
event_surgery %<>% mutate(dwc_decimalLongitude = as.numeric("")) 
```

## Release Event

```{r}
event_release <- input_animals
```

This is an overview of the information related to the surgery event:

```{r}
event_release %>% 
  select(projectname, id_pk, utc_release_date_time, release_location, release_latitude, release_longitude) %>% 
  head(n = 50)
```

NOTE TO SELF: START REVIEWING THE SCRIPT HERE:


### eventID

```{r}
event_release %<>% mutate(dwc_eventID = paste(projectcode, id_pk,"event-release", sep = ":")) 
```

### samplingProtocol

```{r}
event_release %<>% mutate(dwc_samplingProtocol = "") 
```

### eventDate

see [issue40](https://github.com/inbo/etn-occurrences/issues/40)

```{r}
event_release %<>% mutate(dwc_eventDate = utc_release_date_time) 
```

### locality

see [issue41](https://github.com/inbo/etn-occurrences/issues/41)

```{r}
event_release %<>% mutate(dwc_locality = release_location)
```

### decimalLatitude

see [issue11](https://github.com/inbo/etn-occurrences/issues/11)

```{r}
event_release %<>% mutate(dwc_decimalLatitude = release_latitude)
```

### decimalLongitude

see [issue11](https://github.com/inbo/etn-occurrences/issues/11)

```{r}
event_release %<>% mutate(dwc_decimalLongitude = release_longitude)
```

## Stable event core terms

Combine both `event_capture`, `event_surgery` and `event_release` to one `Event Core`:

```{r}
event <- bind_rows(event_capture, event_surgery, event_release)
```

Map metadata fields:

### type

```{r}
event %<>% mutate(meta_type = "event" )
```

### modified

```{r}
event %<>% mutate(meta_modified = date_modified)
```

### language

```{r}
event %<>% mutate(meta_language = "en")
```

### license

```{r}
event %<>% mutate(meta_license = "http://creativecommons.org/publicdomain/zero/1.0/")
```

### rightsHolder:			my_tags::tag_owner_organisation

```{r}
event %<>% mutate()
```

### institutionCode:		my_tags::tag_owner_organisation

```{r}
event %<>% mutate()
```

### datasetID

```{r}
event %<>% mutate(meta_datasetID = "")
```

### datasetName				

```{r}
event %<>% mutate(meta_datasetName = "Acoustic telemetry data of fish in the Scheldt river basin and the Belgian Part of the North Sea (BPNS)")
```

### basisOfRecord:			humanObservation??

```{r}
event %<>% mutate(meta_basisOfRecord = "humanObservation")
```

Map `geodeticDatum` and `coordinateUncertaintyInMeters`:

### geodeticDatum

```{r}
event %<>% mutate(dwc_geodeticDatum = "WGS84") 
```

### coordinateUncertaintyInMeters

```{r}
event %<>% mutate(dwc_coordinateUncertaintyInMeters = "30") 
```

# Occurrence Extension

### occurrenceID

```{r}
event %<>% mutate(dwc_occurrenceID = paste(projectcode, id_pk,"occurrence-capture", sep = ":")) 
```

### recordedBy

see [issue38](https://github.com/inbo/etn-occurrences/issues/38)

```{r}
event %<>% mutate(dwc_recordedBy = person_id) 
```

### scientificName

```{r}
event %<>% mutate(dwc_scientificName = scientific_name) 
```

### kingdom

```{r}
event %<>% mutate(dwc_kingdom = "Animalia") 
```

### phylum

```{r}
event %<>% mutate(dwc_phylum = "Chordata")
```

### vernacularName

```{r}
event %<>% mutate(dwc_vernacularName = common_name) 
```

### taxonRank

```{r}
event %<>% mutate(dwc_taxonRank = "species") 
```

## Post-processing

Select columns starting with `dwc_`

```{r}
event %<>% select(starts_with("meta_"), starts_with("dwc_"))
```

Remove prefix `dwc_`

```{r}
colnames(event) <- str_remove(colnames(event), "dwc_|meta_")
```

Preview data:

```{r}
head(event)
```

Export data:

```{r}
write_csv(event, path = "../data/processed/event.csv", na = "")
```

# Extendend Measurements or Facts Extension

## Capture occurrence

First, we map the eMoF extension linked to the *capture occurrence*.

### Length data

Length data

```{r}
emof_length1 <-
  input_animals %>% 
    filter(!is.na(length)) %>% 
    mutate(dwc_measurementType = length_type) %>% 
    mutate(dwc_measurementUnit = length_units) %>% 
    mutate(dwc_measurementValue = as.character(length))
```

Length2 data

```{r}
emof_length2 <-
  input_animals %>% 
    filter(!is.na(length2)) %>% 
    mutate(dwc_measurementType = length2_type) %>% 
    mutate(dwc_measurementUnit = length2_units) %>% 
    mutate(dwc_measurementValue = as.character(length2))
```

Length3 data

```{r}
emof_length3 <-
  input_animals %>% 
    filter(!is.na(length3)) %>% 
    mutate(dwc_measurementType = length3_type) %>% 
    mutate(dwc_measurementUnit = length3_units) %>% 
    mutate(dwc_measurementValue = as.character(length3))
```

Length4 data

```{r}
emof_length4 <-
  input_animals %>% 
    filter(!is.na(length4)) %>% 
    mutate(dwc_measurementType = length4_type) %>% 
    mutate(dwc_measurementUnit = length4_units) %>% 
    mutate(dwc_measurementValue = as.character(length4))
```

### Weight data

```{r}
emof_weight <- 
  input_animals %>% 
    filter(!is.na(weight)) %>% 
    mutate(dwc_measurementType = "weight") %>% 
    mutate(dwc_measurementUnit = weight_units) %>% 
    mutate(dwc_measurementValue = as.character(weight))
```

### Life stage

```{r}
emof_lifestage <-
  input_animals %>% 
    filter(!is.na(life_stage)) %>% 
    mutate(dwc_measurementType = "life stage") %>% 
    mutate(dwc_measurementUnit = "") %>% 
    mutate(dwc_measurementValue = life_stage)
```

### Age

```{r}
emof_age <- 
  input_animals %>% 
    filter(!is.na(age)) %>% 
    mutate(dwc_measurementType = "age") %>% 
    mutate(dwc_measurementUnit = age_units) %>% 
    mutate(dwc_measurementValue = as.character(age))  
```

### Sex

```{r}
emof_sex <- 
  input_animals %>% 
    filter(!is.na(sex)) %>% 
    mutate(dwc_measurementType = "sex") %>% 
    mutate(dwc_measurementUnit = "") %>% 
    mutate(dwc_measurementValue = sex)  
```

### Origin

```{r}
emof_origin <- 
  input_animals %>% 
    filter(!is.na(wild_or_hatchery)) %>% 
    mutate(dwc_measurementType = "origin") %>% 
    mutate(dwc_measurementUnit = "") %>% 
    mutate(dwc_measurementValue = wild_or_hatchery)  
```

Combine all information:

```{r}
emof_capture_occurrence <-
  bind_rows(emof_length1, emof_length2, emof_length3, emof_length4, emof_weight, emof_lifestage, emof_age, emof_sex, emof_origin)
```

Remove dataframes:

```{r}
rm(emof_length1, emof_length2, emof_length3, emof_length4, emof_weight, emof_lifestage, emof_age, emof_sex, emof_origin)
```

Map `eventID` and `occurrenceID`

### eventID

```{r}
emof_capture_occurrence %<>% mutate(dwc_eventID = paste(projectcode, id_pk,"event-capture", sep = ":")) 
```

### occurrenceID

```{r}
emof_capture_occurrence %<>% mutate(dwc_occurrenceID = paste(projectcode, id_pk,"occurrence-capture", sep = ":")) 
```

### Post-processing

Keep columns with `dwc_` prefix

```{r}
emof_capture_occurrence %<>% select(starts_with("dwc_"))
```

Remove "dwc_prefix"

```{r}
colnames(emof_capture_occurrence) <- str_remove(colnames(emof_capture_occurrence), "dwc_")
```

Rearrange colunms:

```{r}
emof_capture_occurrence %<>% select(eventID, occurrenceID, everything())
```

## Surgery event

### Related to animals

#### Anaesthetic

See [issue 45](https://github.com/inbo/etn-occurrences/issues/45)

```{r}
emof_anaesthetic <- input_animals
```

Inspect `anaesthetic_concentration`:

```{r}
emof_anaesthetic %>% 
  group_by(anaesthetic_concentration) %>% 
  summarize(records = n())
```

Remove all empty values:

```{r}
emof_anaesthetic %<>% filter(!is.na(anaesthetic_concentration))
```

First, we need to separate `anaesthetic_concentration` into its value and unit:

```{r}
emof_anaesthetic %<>% separate(anaesthetic_concentration, into = c("value", "unit"), sep = "m", remove = F)
```


```{r}
emof_anaesthetic %<>% 
  mutate(dwc_measurementType = "anaesthetic") %>% 
  mutate(dwc_measurementValue = value) %>% 
  mutate(dwc_measurementUnit = "ml/l")
```

#### Post operation holding period

See [issue46](https://github.com/inbo/etn-occurrences/issues/46)

```{r}
emof_post_op <- input_animals
```

Remove all values for which post operation holding period is empty (only concerns one value):

```{r}
emof_post_op %<>% filter(!is.na(post_op_holding_period)) 
```

Wait for further mapping for [issue46](https://github.com/inbo/etn-occurrences/issues/46) to be resolved.

```{r}
emof_post_op <-
  emof_post_op %>% 
    mutate(dwc_measurementType = "") %>% 
    mutate(dwc_measurementValue = "") %>% 
    mutate(dwc_measurementUnit = "")
```

### Related to tags

#### Tag full id

```{r}
emof_tag_full_id <- input_tags
```


```{r}
emof
```


Combine `emof_surgery` and `emof_post_op`:

```{r}
emof_surgery <- bind_rows(emof_anaesthetic, emof_post_op)
```

### eventID

Map Â´eventID`:

```{r}
emof_surgery %<>% mutate(dwc_eventID = paste(projectcode, id_pk,"event-surgery", sep = ":")) 
```

### occurrenceID

```{r}
emof_surgery %<>% mutate(dwc_occurrenceID = "") 
```

### Post-processing

Keep columns with `dwc_` prefix

```{r}
emof_surgery %<>% select(starts_with("dwc_"))
```

Remove "dwc_prefix"

```{r}
colnames(emof_surgery) <- str_remove(colnames(emof_surgery), "dwc_")
```

Rearrange colunms:

```{r}
emof_surgery %<>% select(eventID, occurrenceID, everything())
```

Map Extended Measerement or Facts extension:

```{r}
emof <- bind_rows(emof_capture_occurrence, emof_surgery)
```

