---
title: "Darwin Core mapping"
subtitle: "ETN - LifeWatch.be acoustic telemetry data of fish"
author:
- Lien Reysehove
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
#  pdf_document:
#    df_print: kable
#    number_sections: yes
#    toc: yes
#    toc_depth: 3
---


# Setup 

```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Install packages

```{r}
library(tidyverse)      # To do data science
library(magrittr)       # To use %<>% pipes
library(here)           # To find files
library(janitor)        # To clean input data
library(readxl)         # To read Excel files
library(digest)         # To generate hashes
library(rgbif)          # To use GBIF services
library(etn)
```

# Read source data

Connect to database:

```{r}
my_con <- connect_to_etn("damiano.oldoni@inbo.be", "1zFhM2Ic")
```

Load animal and transmitter data:

```{r}
input_animals <- get_animals(my_con)
input_tags  <- get_transmitters(my_con)
```

Filter on requested animal projects:

```{r}
input_animals %>% 
  group_by(projectname) %>% 
  summarise(records = n())
```


```{r}
input_animals %<>% 
  filter(projectname %in% c("2011 Rivierprik",
                            "2012 Leopoldkanaal",
                            "2013 Albertkanaal",
                            "2014 Demer",
                            "2015 Dijle",
                            "2015 PhD Verhelst",
                            "Homarus",
                            "PhD Jan Reubens"))

# Exclude data form `scientific_name`= `Sync tag` in `projectname` = `2013 Albertkanaal` and
# for `scientific_name` = `Gadus morhua` in `projectname` = `2015 PhD Verhelst`
input_animals <-
  input_animals %>% 
    filter(!(projectname == "2013 Albertkanaal" & scientific_name == "Sync tag")) %>%
    filter(!(projectname == "2015 PhD Verhelst" & scientific_name == "Gadus morhua")) %>% 
    filter(!(projectname == "PhD Jan Reubens" & scientific_name == "Sentinel"))
```

Save to CSV:

```{r}
write_csv(input_animals, path = "../data/raw/input_animals.csv", na = "")
```

# Process source data

## Tidy data

Clean data somewhat:

```{r}
input_animals %<>% remove_empty("rows")
```

## Scientific names

Use the [GBIF nameparser](https://www.gbif.org/tools/name-parser) to retrieve nomenclatural information for the scientific names in the checklist:

```{r}
parsed_names <- input_animals %>%
  distinct(scientific_name) %>%
  pull() %>% # Create vector from dataframe
  parsenames() # An rgbif function
```

Show scientific names with nomenclatural issues, i.e. not of `type = SCIENTIFIC` or that could not be fully parsed. Note: these are not necessarily incorrect.

```{r}
parsed_names %>%
  select(scientificname, type, parsed, parsedpartially, rankmarker) %>%
  filter(!(type == "SCIENTIFIC" & parsed == "TRUE" & parsedpartially == "FALSE"))
```

# Event Core

```{r}
event_capture <- input_animals
```

## Capture event

### eventID

```{r}
event_capture %<>% mutate(dwc_eventID = paste(projectcode, id_pk,"event-capture", sep = ":")) 
```

### samplingProtocol

```{r}
event_capture %>% 
  group_by(capture_method) %>%
  summarize(records = n())
```

```{r}
event_capture %<>% mutate(dwc_samplingProtocol = capture_method)
```

### eventDate

```{r}
event_capture %>% 
  group_by(catched_date_time) %>%
  summarize(records = n())
```


```{r}
event_capture %<>% mutate(dwc_eventDate = catched_date_time)
```

### locality

See [issue 34](https://github.com/inbo/etn-occurrences/issues/34)

```{r}
event_capture %<>% mutate(dwc_locality = capture_location)
```

### decimalLatitude

see [issue11](https://github.com/inbo/etn-occurrences/issues/11)

```{r}
event_capture %<>% mutate(dwc_decimalLatitude = capture_latitude)
```

### decimalLongitude

```{r}
event_capture %<>% mutate(dwc_decimalLongitude = capture_longitude)
```

## Surgery Event

```{r}
event_surgery <- input_animals %>% filter(!is.na(date_of_surgery))
```

### eventID

```{r}
event_surgery %<>% mutate(dwc_eventID = paste(projectcode, id_pk,"event-surgery", sep = ":")) 
```

### samplingProtocol

```{r}
event_surgery %<>% mutate(dwc_samplingProtocol = "surgery") 
```

### eventDate

```{r}
event_surgery %<>% mutate(dwc_eventDate = date_of_surgery) 
```

### locality

see [issue42](https://github.com/inbo/etn-occurrences/issues/42)

```{r}
event_surgery %<>% mutate(dwc_locality = surgery_location) 
```

### decimalLatitude

```{r}
event_surgery %<>% mutate(dwc_decimalLatitude = as.numeric("")) 
```

### decimalLongitude

```{r}
event_surgery %<>% mutate(dwc_decimalLongitude = as.numeric("")) 
```

## Release Event

```{r}
event_release <- input_animals
```

### eventID

```{r}
event_release %<>% mutate(dwc_eventID = paste(projectcode, id_pk,"event-release", sep = ":")) 
```

### samplingProtocol

```{r}
event_release %<>% mutate(dwc_samplingProtocol = "") 
```

### eventDate

see [issue40](https://github.com/inbo/etn-occurrences/issues/40)

```{r}
event_release %<>% mutate(dwc_eventDate = utc_release_date_time) 
```

### locality

see [issue41](https://github.com/inbo/etn-occurrences/issues/41)

```{r}
event_release %<>% mutate(dwc_locality = release_location)
```

### decimalLatitude

see [issue11](https://github.com/inbo/etn-occurrences/issues/11)

```{r}
event_release %<>% mutate(dwc_decimalLatitude = release_latitude)
```

### decimalLongitude

see [issue11](https://github.com/inbo/etn-occurrences/issues/11)

```{r}
event_release %<>% mutate(dwc_decimalLongitude = release_longitude)
```

## Stable event core terms

Combine both `event_capture`, `event_surgery` and `event_release` to one `Event Core`:

```{r}
event <- bind_rows(event_capture, event_surgery, event_release)
```

Map `geodeticDatum` and `coordinateUncertaintyInMeters`:

### geodeticDatum

```{r}
event %<>% mutate(dwc_geodeticDatum = "WGS84") 
```

### coordinateUncertaintyInMeters

```{r}
event %<>% mutate(dwc_coordinateUncertaintyInMeters = "30") 
```

# Occurrence Extension

### occurrenceID

```{r}
event %<>% mutate(dwc_occurrenceID = paste(projectcode, id_pk,"occurrence-capture", sep = ":")) 
```

### recordedBy

see [issue38](https://github.com/inbo/etn-occurrences/issues/38)

```{r}
event %<>% mutate(dwc_recordedBy = person_id) 
```

### scientificName

```{r}
event %<>% mutate(dwc_scientificName = scientific_name) 
```

### kingdom

```{r}
event %<>% mutate(dwc_kingdom = "Animalia") 
```

### phylum

```{r}
event %<>% mutate(dwc_phylum = "Chordata")
```

### vernacularName

```{r}
event %<>% mutate(dwc_vernacularName = common_name) 
```

## Post-processing

Select columns starting with `dwc_`

```{r}
event %<>% select(starts_with("dwc_"))
```

Remove prefix `dwc_`

```{r}
colnames(event) <- str_remove(colnames(event), "dwc_")
```

Preview data:

```{r}
head(event)
```

Export data:

```{r}
write_csv(event, path = "../data/processed/event.csv", na = "")
```

# Extendend Measurements or Facts Extension


First, we map the eMoF extension linked to the *capture occurrence* This extension includes the tag properties.

```{r}
emof_capture_tags <- input_animals
```






