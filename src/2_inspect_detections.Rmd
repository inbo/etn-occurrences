---
title: "Inspect detections data"
subtitle: "ETN - LifeWatch.be acoustic telemetry data of fish"
author:
- Lien Reysehove
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
#  pdf_document:
#    df_print: kable
#    number_sections: yes
#    toc: yes
#    toc_depth: 3
---

# Setup 

```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Install packages

```{r}
library(tidyverse)      # To do data science
library(magrittr)       # To use %<>% pipes
library(here)           # To find files
library(janitor)        # To clean input data
library(etn)            # To interact with ETN
library(lubridate)      # To process date and time information
library(glue)
library(odbc)
```

# Connect to database

Get username/password from environment (therefore requires this script to be run on <http://rstudio.lifewatch.be>) and connect to database:

```{r}
my_con <- connect_to_etn(Sys.getenv("username"), Sys.getenv("password"))
```

# Detection occurrences

We need to retrieve the detection data related to the following animal projects:

- 2012 Leopoldkanaal
- 2013 Albertkanaal (excluding Sync tag data)
- 2014 Demer
- 2015 Dijle
- 2015 Phd Verhelst (only for _Anguilla anguilla_)
- Homarus
- Phd Reubens (only for _Gadus morhua_)

We select the specific values for `animal_id_pk`, which correspond with the `id_pk` from the animals table. This will be the dataset we will be processing for the occurrence extension.

```{r}
query <- glue_sql(
    "SELECT DISTINCT id_pk
    FROM vliz.animals_view
    WHERE 
      (projectcode = '2011_rivierprik' 
      OR projectcode = '2012_leopoldkanaal'
      OR projectcode = '2013_albertkanaal'
      OR projectcode = '2014_demer'
      OR projectcode = '2015_dijle'
      OR (projectcode = '2015_phd_verhelst' AND scientific_name = 'Anguilla anguilla')
        OR projectcode = 'homarus'
        OR projectcode = 'phd_reubens')
      AND NOT scientific_name = 'Sentinel'
      AND NOT scientific_name = 'Sync tag'
    " ,
    .con = my_con)

animal_id_pk <- dbGetQuery(my_con, query)
as_tibble(animal_id_pk)
```

Generate vector `animal_id_pk`:

```{r}
animal_id_pk <- animal_id_pk %>% pull(id_pk)
```

Extract detection data from the specific values for `animal_id_pk`:

```{r}
query <- glue_sql(
    "SELECT COUNT(*)
    FROM vliz.detections_view
    WHERE animal_id_pk IN ({animal_id_pk*})
    LIMIT 10",
    animals_id_pk = animal_id_pk,
    .con = my_con)

detections <- dbGetQuery(my_con, query)
as_tibble(detections)
```

## Receiver

Amount of non-zero records:

```{r}
query <- glue_sql(
    "SELECT COUNT(receiver)
    FROM vliz.detections_view
    WHERE animal_id_pk IN ({animal_id_pk*})
    LIMIT 10",
    animals_id_pk = animal_id_pk,
    .con = my_con)

detection_receivers <- dbGetQuery(my_con, query)
as_tibble(detection_receivers)
```

## Transmitter

Amount of non-zero records:

```{r}
query <- glue_sql(
    "SELECT COUNT(transmitter)
    FROM vliz.detections_view
    WHERE animal_id_pk IN ({animal_id_pk*})
    LIMIT 10",
    animals_id_pk = animal_id_pk,
    .con = my_con)

detection_transmitter <- dbGetQuery(my_con, query)
as_tibble(detection_transmitter)
```

## Transmitter name

Amount of non-zero records:

```{r}
query <- glue_sql(
    "SELECT COUNT(transmitter_name)
    FROM vliz.detections_view
    WHERE animal_id_pk IN ({animal_id_pk*})",
    animals_id_pk = animal_id_pk,
    .con = my_con)

detection_transmitter_name <- dbGetQuery(my_con, query)
as_tibble(detection_transmitter_name)
```

Inspect top 100 values for `transmitter_name`:

```{r}
query <- glue_sql(
    "SELECT DISTINCT transmitter_name
    FROM vliz.detections_view
    WHERE animal_id_pk IN ({animal_id_pk*})
    LIMIT 100",
    animals_id_pk = animal_id_pk,
    .con = my_con)

detection_transmitter_name_100 <- dbGetQuery(my_con, query)
as_tibble(detection_transmitter_name_100)
```


## Transmitter serial

Amount of non-zero records:

```{r}
query <- glue_sql(
    "SELECT COUNT(transmitter_serial)
    FROM vliz.detections_view
    WHERE animal_id_pk IN ({animal_id_pk*})",
    animals_id_pk = animal_id_pk,
    .con = my_con)

detection_transmitter_serial <- dbGetQuery(my_con, query)
as_tibble(detection_transmitter_serial)
```

Top 100 values for `transmitter_serial`:

```{r}
query <- glue_sql(
    "SELECT DISTINCT transmitter_serial
    FROM vliz.detections_view
    WHERE animal_id_pk IN ({animal_id_pk*})
    LIMIT 100",
    animals_id_pk = animal_id_pk,
    .con = my_con)

detection_transmitter_serial_100 <- dbGetQuery(my_con, query)
as_tibble(detection_transmitter_serial_100)
```


## Sensor value and sensor unit

Show amount of non-NULL values in `sensor_value`:

```{r}
query <- glue_sql(
    "SELECT COUNT(sensor_value)
    FROM vliz.detections_view
    WHERE animal_id_pk IN ({animal_id_pk*})",
    animals_id_pk = animal_id_pk,
    .con = my_con)

detection_sensor_value <- dbGetQuery(my_con, query)
as_tibble(detection_sensor_value)
```

Show amount of non-NULL values in `sensor_unit`:

```{r}
query <- glue_sql(
    "SELECT COUNT(sensor_unit)
    FROM vliz.detections_view
    WHERE animal_id_pk IN ({animal_id_pk*})",
    animals_id_pk = animal_id_pk,
    .con = my_con)

detection_sensor_unit <- dbGetQuery(my_con, query)
as_tibble(detection_sensor_unit)
```

Show content of non-Null values for `sensor_value` and `sensor_unit`:

```{r}
query <- glue_sql(
    "SELECT DISTINCT sensor_value, sensor_unit
    FROM vliz.detections_view AS detections
    WHERE animal_id_pk IN ({animal_id_pk*})
    ORDER BY sensor_value",
    animals_id_pk = animal_id_pk,
    .con = my_con)

detection_distinct_sensor_value_unit <- dbGetQuery(my_con, query)
as_tibble(detection_distinct_sensor_value_unit)
```

Conclusion: no deviating sensor units/values

## Sensor2 value and sensor2 unit

Show amount of non-NULL values in `sensor2_value`:

```{r}
query <- glue_sql(
    "SELECT COUNT(sensor2_value)
    FROM vliz.detections_view
    WHERE animal_id_pk IN ({animal_id_pk*})",
    animals_id_pk = animal_id_pk,
    .con = my_con)

detection_sensor2_value <- dbGetQuery(my_con, query)
as_tibble(detection_sensor2_value)
```

Show amount of non-NULL values in `sensor2_unit`:

```{r}
query <- glue_sql(
    "SELECT COUNT(sensor2_unit)
    FROM vliz.detections_view
    WHERE animal_id_pk IN ({animal_id_pk*})",
    animals_id_pk = animal_id_pk,
    .con = my_con)

detection_sensor2_unit <- dbGetQuery(my_con, query)
as_tibble(detection_sensor2_unit)
```

Show content of non-Null values for `sensor2_value` and `sensor2_unit`:

```{r}
query <- glue_sql(
    "SELECT DISTINCT sensor2_value, sensor2_unit
    FROM vliz.detections_view AS detections
    WHERE animal_id_pk IN ({animal_id_pk*})
    ORDER BY sensor2_value",
    animals_id_pk = animal_id_pk,
    .con = my_con)

detection_distinct_sensor2_value_unit <- dbGetQuery(my_con, query)
as_tibble(detection_distinct_sensor2_value_unit)
```

## station_name

Amount of non-zero records:

```{r}
query <- glue_sql(
    "SELECT COUNT(station_name)
    FROM vliz.detections_view
    WHERE animal_id_pk IN ({animal_id_pk*})",
    animals_id_pk = animal_id_pk,
    .con = my_con)

detection_station_name <- dbGetQuery(my_con, query)
as_tibble(detection_station_name)
```

Show combination between `station_name` and `deployment_station_name`:

```{r}
query <- glue_sql(
    "SELECT DISTINCT station_name, deployment_station_name
    FROM vliz.detections_view AS detections
    WHERE animal_id_pk IN ({animal_id_pk*})
      AND NOT station_name = ''
      AND NOT station_name = deployment_station_name
    ORDER BY station_name",
    animals_id_pk = animal_id_pk,
    .con = my_con)

detection_station_name_comparison <- dbGetQuery(my_con, query)
as_tibble(detection_station_name_comparison)
```

## datetime

Amount of non-zero records:

```{r}
query <- glue_sql(
    "SELECT COUNT(datetime)
    FROM vliz.detections_view
    WHERE animal_id_pk IN ({animal_id_pk*})",
    animals_id_pk = animal_id_pk,
    .con = my_con)

detection_datetime <- dbGetQuery(my_con, query)
as_tibble(detection_datetime)
```

Inspect `datetime` information:

```{r}
query <- glue_sql(
    "SELECT DISTINCT datetime, COUNT(datetime)
    FROM vliz.detections_view
    WHERE animal_id_pk IN ({animal_id_pk*})
    GROUP BY datetime
    ORDER BY count(datetime) DESC
    LIMIT 100",
    animals_id_pk = animal_id_pk,
    .con = my_con)

detection_datetime_100 <- dbGetQuery(my_con, query)
as_tibble(detection_datetime_100)
```

Select minimum and maxiumum dates:

```{r}
query <- glue_sql(
    "SELECT MIN (datetime), MAX(datetime)
    FROM vliz.detections_view AS detections
    WHERE animal_id_pk IN ({animal_id_pk*})
    " ,
    animals_id_pk = animal_id_pk,
    .con = my_con)

detection_min_max_datetime <- dbGetQuery(my_con, query)
as_tibble(detection_min_max_datetime)
```

## id_pk

```{r}
query <- glue_sql(
    "SELECT COUNT(id_pk)
    FROM vliz.detections_view
    WHERE animal_id_pk IN ({animal_id_pk*})",
    animals_id_pk = animal_id_pk,
    .con = my_con)

detection_id_pk <- dbGetQuery(my_con, query)
as_tibble(detection_id_pk)
```

Should be equal to the amount of unique values of `id_pk`:

```{r}
query <- glue_sql(
    "SELECT COUNT(DISTINCT id_pk)
    FROM vliz.detections_view
    WHERE animal_id_pk IN ({animal_id_pk*})",
    animals_id_pk = animal_id_pk,
    .con = my_con)

detection_id_pk_unique <- dbGetQuery(my_con, query)
as_tibble(detection_id_pk_unique)
```

## latitude and longitude

Inspect amount of non-NULL and non-zero values for latitude :

```{r}
query <- glue_sql(
    "SELECT COUNT (latitude)
    FROM vliz.detections_view AS detections
    WHERE animal_id_pk IN ({animal_id_pk*})
      AND NOT latitude = 0
    " ,
    animal_id_pk = animal_id_pk,  
    .con = my_con)

detection_non_zero_latitude <- dbGetQuery(my_con, query)
as_tibble(detection_non_zero_latitude)
```

Inspect amount of non-NULL and non-zero values for longitude :

```{r}
query <- glue_sql(
    "SELECT COUNT (longitude)
    FROM vliz.detections_view AS detections
    WHERE animal_id_pk IN ({animal_id_pk*})
      AND NOT longitude = 0
    " ,
    animal_id_pk = animal_id_pk,  
    .con = my_con)

detection_non_zero_longitude <- dbGetQuery(my_con, query)
as_tibble(detection_non_zero_longitude)
```

Inspect, ter comparison, all non-NULL values for deployment_lat:

```{r}
query <- glue_sql(
    "SELECT COUNT (deployment_lat)
    FROM vliz.detections_view AS detections
    WHERE animal_id_pk IN ({animal_id_pk*})
      AND NOT deployment_lat = 0
    " ,
    animal_id_pk = animal_id_pk,  
    .con = my_con)

detection_non_zero_deployment_lat <- dbGetQuery(my_con, query)
as_tibble(detection_non_zero_deployment_lat)
```

and for `deployment_long`:

```{r}
query <- glue_sql(
    "SELECT COUNT (deployment_long)
    FROM vliz.detections_view AS detections
    WHERE animal_id_pk IN ({animal_id_pk*})
      AND NOT deployment_long = 0
    " ,
    animal_id_pk = animal_id_pk,  
    .con = my_con)

detection_non_zero_deployment_long <- dbGetQuery(my_con, query)
as_tibble(detection_non_zero_deployment_long)
```

Extract subset from the database to gain better insight into `latitude` and `longitude`

```{r}
query <- glue_sql(
    "SELECT receiver, transmitter, datetime, latitude, deployment_lat, longitude, deployment_long
    FROM vliz.detections_view AS detections
    WHERE animal_id_pk IN ({animal_id_pk*})
      AND NOT latitude = deployment_lat
      AND NOT latitude = 0
      LIMIT 1000
    " ,
    animal_id_pk = animal_id_pk,    
    .con = my_con)

detection_latitude_longitude_1000 <- dbGetQuery(my_con, query)
as_tibble(detection_latitude_longitude_1000)
```

## animal_project_code

Inspect non-NUll values for `scientific_name`

```{r}
query <- glue_sql(
    "SELECT COUNT (animal_project_code)
    FROM vliz.detections_view AS detections
    WHERE animal_id_pk IN ({animal_id_pk*})
    " ,
    animal_id_pk = animal_id_pk,   
    .con = my_con)

detection_animal_project_code <- dbGetQuery(my_con, query)
as_tibble(detection_animal_project_code)
```

Show distinct values:

```{r}
query <- glue_sql(
    "SELECT DISTINCT animal_project_code
    FROM vliz.detections_view AS detections
    WHERE animal_id_pk IN ({animal_id_pk*})
    " ,
    animal_id_pk = animal_id_pk,   
    .con = my_con)

detection_animal_project_code_distinct <- dbGetQuery(my_con, query)
as_tibble(detection_animal_project_code_distinct)
```

## animal_moratorium

Inspect non-NUll values for `animal_moratorium`

```{r}
query <- glue_sql(
    "SELECT COUNT (animal_moratorium)
    FROM vliz.detections_view AS detections
    WHERE animal_id_pk IN ({animal_id_pk*})
    " ,
    animal_id_pk = animal_id_pk,   
    .con = my_con)

detection_animal_moratorium <- dbGetQuery(my_con, query)
as_tibble(detection_animal_moratorium)
```

Show distinct values:

```{r}
query <- glue_sql(
    "SELECT DISTINCT animal_moratorium
    FROM vliz.detections_view AS detections
    WHERE animal_id_pk IN ({animal_id_pk*})
    " ,
    animal_id_pk = animal_id_pk,   
    .con = my_con)

detection_animal_moratorium_distinct <- dbGetQuery(my_con, query)
as_tibble(detection_animal_moratorium_distinct)
```

Show all values for which there's an animal moratorium:

```{r}
query <- glue_sql(
    "SELECT DISTINCT animal_project_code, scientific_name
    FROM vliz.detections_view AS detections
    WHERE animal_id_pk IN ({animal_id_pk*})
      AND animal_moratorium = '1'
    " ,
    animal_id_pk = animal_id_pk,   
    .con = my_con)

detection_animal_moratorium_present <- dbGetQuery(my_con, query)
as_tibble(detection_animal_moratorium_present)
```

We have the permission to publish these datasets.

## scientific name and common names

Inspect non-NUll values for `scientific_name`

```{r}
query <- glue_sql(
    "SELECT COUNT (scientific_name)
    FROM vliz.detections_view AS detections
    WHERE animal_id_pk IN ({animal_id_pk*})
    " ,
    animal_id_pk = animal_id_pk,   
    .con = my_con)

detection_scientific_name <- dbGetQuery(my_con, query)
as_tibble(detection_scientific_name)
```

Inspect non-NUll values for `animal_common_name`

```{r}
query <- glue_sql(
    "SELECT COUNT (animal_common_name)
    FROM vliz.detections_view AS detections
    WHERE animal_id_pk IN ({animal_id_pk*})
    " ,
    animal_id_pk = animal_id_pk,
    .con = my_con)

detection_common_name <- dbGetQuery(my_con, query)
as_tibble(detection_common_name)
```


Inspect unique values and combinations with `animal_common_name`:

```{r}
query <- glue_sql(
    "SELECT DISTINCT scientific_name, animal_common_name
    FROM vliz.detections_view AS detections
    WHERE animal_id_pk IN ({animal_id_pk*})
    " ,
    animal_id_pk = animal_id_pk,
    .con = my_con)

detection_common_name <- dbGetQuery(my_con, query)
as_tibble(detection_common_name)
```

## animal sex

```{r}
query <- glue_sql(
    "SELECT COUNT (animal_sex)
    FROM vliz.detections_view AS detections
    WHERE transmitter IN ({transmitters*})
      AND animal_project_code IN ({animals*})
    " ,
    transmitters = transmitters,
    animals = animal_projects,    
    .con = my_con)

non_NULL_animal_sex <- dbGetQuery(my_con, query)
as_tibble(non_NULL_animal_sex)
```

View unique values:

```{r}
query <- glue_sql(
    "SELECT DISTINCT animal_sex
    FROM vliz.detections_view AS detections
    WHERE transmitter IN ({transmitters*})
      AND animal_project_code IN ({animals*})
    " ,
    transmitters = transmitters,
    animals = animal_projects,    
    .con = my_con)

distinct_animal_sex <- dbGetQuery(my_con, query)
as_tibble(distinct_animal_sex)
```

