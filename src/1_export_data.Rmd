---
title: "Export data"
subtitle: "ETN - LifeWatch.be acoustic telemetry data of fish"
author:
- Lien Reysehove
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
#  pdf_document:
#    df_print: kable
#    number_sections: yes
#    toc: yes
#    toc_depth: 3
---

This script is used to export data from the etn database to the [raw data folder](https://github.com/inbo/etn-occurrences/tree/master/data/raw) in this repository. The goal is to simplify data exploration. We use this for the following tables in the database:

- `vliz_animals.view`
- `vliz_tags`
- `vliz_deployments.view`
- `vliz_receivers`

We do not export data from the `vliz_detections.view` table as this table is too large. Exploration of this table is done in `2_inspect_detections.Rmd`.

# Setup 

```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Install packages

```{r}
library(tidyverse)      # To do data science
library(magrittr)       # To use %<>% pipes
library(here)           # To find files
library(etn)            # To interact with ETN
library(glue)
```

# Connect to database

Get username/password from environment (therefore requires this script to be run on <http://rstudio.lifewatch.be>) and connect to database:

```{r}
my_con <- connect_to_etn(Sys.getenv("username"), Sys.getenv("password"))
```


# Export animals data

Extract all information from the animals metadata table (`vliz.animals_view`) related to the following animal projects:

- 2012 Leopoldkanaal
- 2013 Albertkanaal (excluding Sync tag data)
- 2014 Demer
- 2015 Dijle
- 2015 Phd Verhelst (only for _Anguilla anguilla_)
- Homarus
- Phd Reubens (only for _Gadus morhua_)

```{r}
query <- glue_sql(
    "SELECT *
    FROM vliz.animals_view
    WHERE 
      (projectcode = '2011_rivierprik' 
        OR projectcode = '2012_leopoldkanaal'
        OR projectcode = '2013_albertkanaal'
        OR projectcode = '2014_demer'
        OR projectcode = '2015_dijle'
        OR (projectcode = '2015_phd_verhelst' AND scientific_name = 'Anguilla anguilla')
        OR projectcode = 'homarus'
        OR projectcode = 'phd_reubens')
      AND NOT scientific_name = 'Sentinel'
      AND NOT scientific_name = 'Sync tag'
    " ,
    .con = my_con)

animals <- dbGetQuery(my_con, query)
as_tibble(animals)
```

Export data to `raw`:

```{r}
animals %>% write_csv(here::here("data", "raw", "input_animals.csv"), na = "")
```

# Export transmitter data

Select transmitter information fomr `vliz_tags`:

```{r}
query <- glue_sql(
    "SELECT tags.*, animals.projectcode, animals.scientific_name
     FROM vliz.tags
        LEFT JOIN vliz.animal_tag_release ON (animal_tag_release.tag_fk = tags.id_pk)
        LEFT JOIN vliz.animals_view animals ON (animals.id_pk = animal_tag_release.animal_fk)
    WHERE 
      (projectcode = '2011_rivierprik' 
        OR projectcode = '2012_leopoldkanaal'
        OR projectcode = '2013_albertkanaal'
        OR projectcode = '2014_demer'
        OR projectcode = '2015_dijle'
        OR (projectcode = '2015_phd_verhelst' AND scientific_name = 'Anguilla anguilla')
        OR projectcode = 'homarus'
        OR projectcode = 'phd_reubens')
      AND NOT scientific_name = 'Sentinel'
      AND NOT scientific_name = 'Sync tag'
    ", 
    .con = my_con)

transmitters <- dbGetQuery(my_con, query)
as_tibble(transmitters)
```

Export transmitters data:

```{r}
transmitters %>% write_csv(here::here("data", "raw", "input_transmitters.csv"), na = "")
```

# Export deployment data

Extract all receivers involved in the detections of the specific animal projects listed earlier. We can't select on specific animal projects here. Hence, we use the network projects included in the specific animal projects.

```{r}
query <- glue_sql(
    "SELECT *
      FROM vliz.deployments_view AS deployments
      WHERE projectcode = 'albert'
        OR projectcode = 'bovenschelde'
        OR projectcode = 'bpns'
        OR projectcode = 'demer'
        OR projectcode = 'dijle'
        OR projectcode = 'leopold'
        OR projectcode = 'maas'
        OR projectcode = 'saeftinghe'
        OR projectcode = 'ws1'
        OR projectcode = 'ws2'
        OR projectcode = 'ws3'    ",
    .con = my_con)

deployments <- dbGetQuery(my_con, query)
as_tibble(deployments)
```

Export `deployments` as .csv:

```{r}
write_csv(deployments, here::here("data","raw","input_deployments.csv"), na = "")
```

# Export receivers

```{r}
query <- glue_sql("
      SELECT DISTINCT 
        receivers.* ,
        deployments.projectcode,
        etn_group.name as owner_organisation
      FROM vliz.receivers
        JOIN vliz.deployments_view deployments ON (receivers.id_pk = deployments.receiver_fk)
        JOIN vliz.etn_group AS etn_group ON (receivers.owner_group_fk = etn_group.id_pk)
       WHERE projectcode = 'albert'
        OR projectcode = 'bovenschelde'
        OR projectcode = 'bpns'
        OR projectcode = 'demer'
        OR projectcode = 'dijle'
        OR projectcode = 'leopold'
        OR projectcode = 'maas'
        OR projectcode = 'saeftinghe'
        OR projectcode = 'ws1'
        OR projectcode = 'ws2'
        OR projectcode = 'ws3'    ",
      .con = my_con)

receivers <- dbGetQuery(my_con, query)
as_tibble(receivers)
```

Export `receivers` as .csv:

```{r}
write_csv(receivers, here::here("data","raw","input_receivers.csv"), na = "")
```



