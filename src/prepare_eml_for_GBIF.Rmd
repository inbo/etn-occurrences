---
title: "Prepare EML data for GBIF IPT upload"
author: "Sanne Govaert"
date: "`r Sys.Date()`"
output: html_document
---

This script prepares EML data extracted from [IMIS](https://www.vliz.be/en/imis?module=dataset) for upload to a [GBIF IPT](https://gbif.org/ipt).

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

Load libraries

```{r}
library(EML)
library(here)
library(stringr)
```

# Set user-defined values

```{r}
project_id <- "2011_RIVIERPRIK"
metadata_provider <- person(
  given = "Peter",
  family = "Desmet",
  email = "peter.desmet@inbo.be",
  comment = c(ORCID = "0000-0002-8442-8025")
)
```

# Read EML 

```{r}
eml <- EML::read_eml(here::here("data", project_id, "raw", "eml.xml"))
```

# Cleaning

## Basic Metadata

### Set Update frequency to "Not planned"

```{r}
eml$dataset$maintenance$maintenanceUpdateFrequency <- "Not planned"
```

### Clean Resource contacts and Resource creators

- Generic email "info@inbo.be" is removed.
- Organization "Vlaamse overheid; Beleidsdomein Omgeving; Instituut voor Natuur- en Bosonderzoek" is replaced by "Research Institute for Nature and Forest (INBO)".

```{r}
update_contact <- function(contact) {
  if (
    !is.null(contact$electronicMailAddress) && contact$electronicMailAddress == "info@inbo.be") {
    contact$electronicMailAddress <- NULL
  }
  if (!is.null(contact$organizationName) && contact$organizationName == "Vlaamse overheid; Beleidsdomein Omgeving; Instituut voor Natuur- en Bosonderzoek") {
    contact$organizationName <- "Research Institute for Nature and Forest (INBO)"
  }
  contact
}

eml$dataset$creator <- purrr::map(eml$dataset$creator, update_contact)
eml$dataset$contact <- update_contact(eml$dataset$contact)
```

### Set Metadata provider

```{r}
eml$dataset$metadataProvider <- EML::set_responsibleParty(
  givenName = metadata_provider$given,
  surName = metadata_provider$family,
  electronicMailAddress = metadata_provider$email,
  userId = if (!is.null(metadata_provider$comment[["ORCID"]])) {
    list(directory = "https://orcid.org/", metadata_provider$comment[["ORCID"]])
  } else {
    NULL
  }
)
```

## Taxonomic coverage

Remove description.

```{r}
tax_coverage <- eml$dataset$coverage$taxonomicCoverage
number_of_species <- length(tax_coverage)
clean_coverage <- function(tax_coverage) {
  tax_coverage <- tax_coverage[names(tax_coverage) != "id"]
  tax_coverage <- tax_coverage[names(tax_coverage) != "generalTaxonomicCoverage"]
  return(tax_coverage)
}

if (number_of_species == 1) {
  eml$dataset$coverage$taxonomicCoverage$id <- NULL
  eml$dataset$coverage$taxonomicCoverage$generalTaxonomicCoverage <- NULL
} else {
  eml$dataset$coverage$taxonomicCoverage <- purrr::map(tax_coverage, clean_coverage)
}
```

## Keywords

Clean keywords.

```{r}
eml$dataset$keywordSet <- purrr::map(eml$dataset$keywordSet, ~ {
  if (!"keywordThesaurus" %in% names(.)) {
    . <- c(., keywordThesaurus = "N/A")
  }
  .
})
```

## Associated Parties

Remove associated parties.

```{r}
eml$dataset$associatedParty <- NULL
```

## Citations

Clean Resource citation identifier

```{r}
identifier_raw <- eml$additionalMetadata$metadata$gbif$citation$identifier
identifier <- sub("dx.", "", identifier_raw)
eml$additionalMetadata$metadata$gbif$citation$identifier <- identifier
```
## Update Description in Metadata

The abstract on IMIS is limited to 1000 characters. Extra paragraphs are living in `additionalInfo` (Additional metadata). 
We move the `additionalInfo` to the abstract and clean it up.

```{r}
# Get additional paragraphs
additional_info <- eml$dataset$additionalInfo$para

# Split `additional_info` in paragraphs
paragraphs <- unlist(strsplit(additional_info, "<p>|</p>|\n", perl = TRUE))
paragraphs <- paragraphs[!paragraphs %in% c("", "<![CDATA[", "<br/>", "]]>")]
paragraphs <- unlist(strsplit(paragraphs, " Data were exported from", perl = TRUE))

# Extract publication year
citation <- eml$additionalMetadata$metadata$gbif$citation$citation
pattern <- "\\(\\d{4}\\)"
year <- stringr::str_extract(citation, pattern) %>% 
  stringr::str_remove_all("\\(|\\)")

# Extract first author
first_author <- stringr::str_split_1(citation, ",")[1]

# Write new paragraph
new_paragraph <- paste0("Data have been standardized to Darwin Core using the <a href=\"https://inbo.github.io/etn/\"> etn </a> package and are downsampled to the first detection per hour. The original data are managed in the European Tracking Network data platform (<a href=\"https://www.lifewatch.be/etn/\">https://www.lifewatch.be/etn/</a>) and are available in ", first_author, " et al. (", year, ", <a href=\"", identifier, "\">", identifier, ")</a>.")

# Update last paragraph
paragraphs[length(paragraphs)] <- new_paragraph

# Rearrange paragraphs: abstract + additional_info
eml$dataset$abstract$para <- c(eml$dataset$abstract$para, paragraphs)

# Delete `additionalInfo`
eml$dataset$additionalInfo <- NULL
```

# Write EML

```{r}
eml_path <- here::here("data", project_id, "processed", "eml.xml")
EML::write_eml(eml, eml_path)
```


